module Test.Parse.Module exposing ( tests )

import Expect exposing (Expectation)
import Test exposing (Test, describe, test, fuzz)
import Parser.Advanced as Parser
import Parse.Module as PM
import SourcePosition
import AST.Source as AST


tests : Test
tests =
    describe "Parse.Module"
        [ test "Empty module" <| \_ ->
            Parser.run PM.parser
                """
                module MyModule exposing (..)
                """
                |> expect
                    { name =
                        SourcePosition.at
                            { row = 1, col = 8 }
                            { row = 1, col = 16 }
                            "MyModule"
                    , exports = AST.Open
                    , docs = Nothing
                    , imports = []
                    , values = []
                    , unions = []
                    , aliases = []
                    , binops = []
                    , effects = AST.NoEffects
                    }
        , test "Empty module with exposings (valid when parsing)" <| \_ ->
            Parser.run PM.parser
                """
                module MyModule exposing ( Model, Msg (..), (==), view )
                """
                |> expect
                    { name =
                        SourcePosition.at
                            { row = 1, col = 8 }
                            { row = 1, col = 16 }
                            "MyModule"
                    , exports =
                        AST.Explicit
                            [ AST.ExposedUpper
                                { name =
                                    SourcePosition.at
                                        { row = 1, col = 28 }
                                        { row = 1, col = 33 }
                                        "Model"
                                , privacy = AST.Private
                                }
                            , AST.ExposedUpper
                                { name =
                                    SourcePosition.at
                                        { row = 1, col = 35 }
                                        { row = 1, col = 38 }
                                        "Msg"
                                , privacy = AST.Public
                                }
                            , AST.ExposedOperator <|
                                SourcePosition.at
                                    { row = 1, col = 46 }
                                    { row = 1, col = 48 }
                                    "=="
                            , AST.ExposedLower <|
                                SourcePosition.at
                                    { row = 1, col = 51 }
                                    { row = 1, col = 55 }
                                    "view"
                            ]
                    , docs = Nothing
                    , imports = []
                    , values = []
                    , unions = []
                    , aliases = []
                    , binops = []
                    , effects = AST.NoEffects
                    }
        , test "Docs" <| \_ ->
            Parser.run PM.parser
                """
                module MyModule exposing (..)

                {-| The documentation for MyModule
                -}
                """
                |> expect
                    { name =
                        SourcePosition.at
                            { row = 1, col = 8 }
                            { row = 1, col = 16 }
                            "MyModule"
                    , exports = AST.Open
                    , docs = Just <|
                        SourcePosition.at
                            { row = 3, col = 1 }
                            { row = 4, col = 3 }
                            "The documentation for MyModule"
                    , imports = []
                    , values = []
                    , unions = []
                    , aliases = []
                    , binops = []
                    , effects = AST.NoEffects
                    }
        , test "imports" <| \_ ->
            Parser.run PM.parser
                """
                module MyModule exposing (..)

                import Array
                """
                |> expect
                    { name =
                        SourcePosition.at
                            { row = 1, col = 8 }
                            { row = 1, col = 16 }
                            "MyModule"
                    , exports = AST.Open
                    , docs = Nothing
                    , imports =
                        [ SourcePosition.at
                            { row = 3, col = 1 }
                            { row = 3, col = 13 }
                            { module_ =
                                SourcePosition.at
                                    { row = 3, col = 8 }
                                    { row = 3, col = 13 }
                                    "Array"
                            , alias = Nothing
                            , expose = AST.Explicit []
                            }
                        ]
                    , values = []
                    , unions = []
                    , aliases = []
                    , binops = []
                    , effects = AST.NoEffects
                    }
        , test "imports with alias" <| \_ ->
            Parser.run PM.parser
                """
                module MyModule exposing (..)

                import Array as A
                """
                |> expect
                    { name =
                        SourcePosition.at
                            { row = 1, col = 8 }
                            { row = 1, col = 16 }
                            "MyModule"
                    , exports = AST.Open
                    , docs = Nothing
                    , imports =
                        [ SourcePosition.at
                            { row = 3, col = 1 }
                            { row = 3, col = 18 }
                            { module_ =
                                SourcePosition.at
                                    { row = 3, col = 8 }
                                    { row = 3, col = 13 }
                                    "Array"
                            , alias = Just "A"
                            , expose = AST.Explicit []
                            }
                        ]
                    , values = []
                    , unions = []
                    , aliases = []
                    , binops = []
                    , effects = AST.NoEffects
                    }
        , test "imports with alias and exposing" <| \_ ->
            Parser.run PM.parser
                """
                module MyModule exposing (..)

                import Array exposing (..)
                import Nested.Module as N.M exposing (T)
                """
            |> expect
                { name =
                    SourcePosition.at
                        { row = 1, col = 8 }
                        { row = 1, col = 16 }
                        "MyModule"
                , exports = AST.Open
                , docs = Nothing
                , imports =
                    [ SourcePosition.at
                        { row = 3, col = 1 }
                        { row = 3, col = 27 }
                        { module_ =
                            SourcePosition.at
                                { row = 3, col = 8 }
                                { row = 3, col = 13 }
                                "Array"
                        , alias = Nothing
                        , expose = AST.Open
                        }
                    , SourcePosition.at
                        { row = 4, col = 1 }
                        { row = 4, col = 41 }
                        { module_ =
                            SourcePosition.at
                                { row = 4, col = 8 }
                                { row = 4, col = 21 }
                                "Nested.Module"
                        , alias = Just "N.M"
                        , expose =
                            AST.Explicit
                                [ AST.ExposedUpper
                                    { name =
                                        SourcePosition.at
                                            { row = 4, col = 39 }
                                            { row = 4, col = 40 }
                                            "T"
                                    , privacy = AST.Private
                                    }
                                ]
                            }
                        ]
                , values = []
                , unions = []
                , aliases = []
                , binops = []
                , effects = AST.NoEffects
                }
        , test "operators" <| \_ ->
            Parser.run PM.parser
                """
                module MyModule exposing (..)

                infix left  0 (|>) = apR
                infix right 3 (&&) = and
                infix non   4 (==) = eq
                """
                |> expect
                    { name =
                        SourcePosition.at
                            { row = 1, col = 8 }
                            { row = 1, col = 16 }
                            "MyModule"
                    , exports = AST.Open
                    , docs = Nothing
                    , imports = []
                    , values = []
                    , unions = []
                    , aliases = []
                    , binops =
                        [ SourcePosition.at
                            { row = 3, col = 1 }
                            { row = 3, col = 25 }
                            { fn = "apR"
                            , symbol = "|>"
                            , associativity = AST.OpALeft
                            , precedence = 0
                            }
                        , SourcePosition.at
                            { row = 4, col = 1 }
                            { row = 4, col = 25 }
                            { fn = "and"
                            , symbol = "&&"
                            , associativity = AST.OpARight
                            , precedence = 3
                            }
                        , SourcePosition.at
                            { row = 5, col = 1 }
                            { row = 5, col = 24 }
                            { fn = "eq"
                            , symbol = "=="
                            , associativity = AST.OpANone
                            , precedence = 4
                            }
                        ]
                    , effects = AST.NoEffects
                    }
        ]


expect : AST.Module -> Result (Array (Parser.DeadEnd c e)) AST.Module -> Expectation
expect expected result =
    when result is
        Err err ->
            Expect.fail (Debug.toString err)

        Ok res ->
            Expect.equal expected res
