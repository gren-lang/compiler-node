module Test.Parse.Pattern exposing ( tests )

import Expect exposing (Expectation)
import Test exposing (Test, describe, test, fuzz)
import Fuzz exposing (Fuzzer)
import Parser.Advanced as Parser
import Parse.Pattern as PT
import AST.Source as AST
import SourcePosition


tests : Test
tests =
    describe "Parse.Pattern"
        [ test "vars" <| \_ ->
            Parser.run PT.parser "var"
                |> expectPattern (AST.PVar "var")
        , test "wildcard" <| \_ ->
            Parser.run PT.parser "_"
                |> expectPattern (AST.PAnything "")
        , test "wildcard (named)" <| \_ ->
            Parser.run PT.parser "_test"
                |> expectPattern (AST.PAnything "test")
        , test "constructor (unqualified)" <| \_ ->
            Parser.run PT.parser "Ctor"
                |> expectPattern
                    (AST.PCtor
                        { arg = Nothing
                        , name =
                            SourcePosition.at
                                { row = 1, col = 1 }
                                { row = 1, col = 5 }
                                "Ctor"
                        }
                    )
        , test "constructor (with args)" <| \_ ->
            Parser.run PT.parser "Ctor arg"
                |> expectPattern
                    (AST.PCtor
                        { arg =
                            Just <|
                                SourcePosition.at
                                    { row = 1, col = 6 }
                                    { row = 1, col = 9 }
                                    (AST.PVar "arg")
                        , name =
                            SourcePosition.at
                                { row = 1, col = 1 }
                                { row = 1, col = 5 }
                                "Ctor"
                        }
                    )
        , test "constructor (qualified)" <| \_ ->
            Parser.run PT.parser "My.Ctor"
                |> expectPattern
                    (AST.PCtorQual
                        { varRegion =
                            { start = { row = 1, col = 1 }
                            , end = { row = 1, col = 8 }
                            }
                        , arg = Nothing
                        , module_ = "My"
                        , name = "Ctor"
                        }
                    )
        , test "ints" <| \_ ->
            Parser.run PT.parser "160"
                |> expectPattern
                    (AST.PInt { isHex = False, value = 160 })
        , test "ints (hex)" <| \_ ->
            Parser.run PT.parser "0xAB"
                |> expectPattern
                    (AST.PInt { isHex = True, value = 171 })
        , test "string" <| \_ ->
            Parser.run PT.parser "\"some String\""
                |> expectPattern
                    (AST.PStr "some String")
        , test "char" <| \_ ->
            Parser.run PT.parser "'z'"
                |> expectPattern
                    (AST.PChr 'z')
        ]


expectPattern : a -> Result (Array (Parser.DeadEnd c e)) (SourcePosition.Located a) -> Expectation
expectPattern expected result =
    when result is
        Err err ->
            Expect.fail (Debug.toString err)

        Ok { value } ->
            Expect.equal expected value


expectErr : PT.Error -> Result (Array (Parser.DeadEnd c PT.Error)) a -> Expectation
expectErr expected result =
    when result is
        Ok _ ->
            Expect.fail "Expected error"

        Err problems ->
            when Array.first problems is
                Just firstProblem ->
                    Expect.equal expected firstProblem.problem

                Nothing ->
                    Expect.fail "Failed, but with no problems..."
